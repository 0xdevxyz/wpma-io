# ============================================
# WPMA.io Docker Compose
# ============================================
# WICHTIG: Erstelle eine .env Datei mit den Secrets!
# Siehe: env.secure.template
# ============================================

services:
  wpma-postgres:
    image: postgres:16-alpine
    container_name: wpma-postgres
    ports:
      - "127.0.0.1:5434:5432"
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-wpma_db}
      POSTGRES_USER: ${POSTGRES_USER:-wpma_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
    volumes:
      - wpma-postgres-data:/var/lib/postgresql/data
    networks:
      - wpma-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-wpma_user} -d ${POSTGRES_DB:-wpma_db}"]
      interval: 10s
      timeout: 5s
      retries: 5

  wpma-redis:
    image: redis:7-alpine
    container_name: wpma-redis
    ports:
      - "127.0.0.1:6381:6379"
    command: redis-server --requirepass "${REDIS_PASSWORD:?REDIS_PASSWORD is required}"
    volumes:
      - wpma-redis-data:/data
    networks:
      - wpma-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: wpma-backend
    ports:
      - "127.0.0.1:8000:8000"
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: ${PORT:-8000}
      DATABASE_URL: ${DATABASE_URL:?DATABASE_URL is required}
      DATABASE_SSL: ${DATABASE_SSL:-false}
      DATABASE_POOL_MAX: ${DATABASE_POOL_MAX:-20}
      REDIS_HOST: ${REDIS_HOST:-wpma-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD:?REDIS_PASSWORD is required}
      REDIS_DB: ${REDIS_DB:-3}
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET is required}
      FRONTEND_URL: ${FRONTEND_URL:-https://app.wpma.io}
      # Optional Services
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY:-}
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-}
      SENTRY_DSN: ${SENTRY_DSN:-}
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASS: ${SMTP_PASS:-}
      # Reverse Proxy
      VIRTUAL_HOST: ${VIRTUAL_HOST:-api.wpma.io}
      LETSENCRYPT_HOST: ${LETSENCRYPT_HOST:-api.wpma.io}
      VIRTUAL_PORT: ${VIRTUAL_PORT:-8000}
    networks:
      - proxy-network
      - wpma-network
    restart: unless-stopped
    depends_on:
      wpma-postgres:
        condition: service_healthy
      wpma-redis:
        condition: service_healthy

  frontend:
    build:
      context: ./wpma-frontend
      dockerfile: Dockerfile
    container_name: wpma-frontend
    environment:
      NEXT_PUBLIC_API_URL: "https://api.wpma.io"
      NODE_ENV: "production"
      VIRTUAL_HOST: "app.wpma.io"
      LETSENCRYPT_HOST: "app.wpma.io"
      VIRTUAL_PORT: "3000"
    networks:
      - proxy-network
      - wpma-network
    restart: unless-stopped
    depends_on:
      - backend

  landing:
    image: nginx:alpine
    container_name: wpma-landing
    ports:
      - "80"
    volumes:
      - ./landing:/usr/share/nginx/html
      - ./landing/nginx.conf:/etc/nginx/nginx.conf:ro
    environment:
      VIRTUAL_HOST: "wpma.io,www.wpma.io"
      LETSENCRYPT_HOST: "wpma.io,www.wpma.io"
      VIRTUAL_PORT: "80"
    networks:
      - proxy-network
    restart: unless-stopped

networks:
  proxy-network:
    external: true
  shared-network:
    external: true
  wpma-network:
    driver: bridge

volumes:
  wpma-postgres-data:
    driver: local
  wpma-redis-data:
    driver: local
