# ============================================
# WPMA.io Production Docker Compose
# ============================================
# WICHTIG: Erstelle eine .env Datei mit den Secrets!
# Siehe: env.secure.template
# ============================================

services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: wpma-backend
    ports:
      - "127.0.0.1:8000:8000"
    environment:
      NODE_ENV: production
      PORT: ${PORT:-8000}
      DATABASE_URL: ${DATABASE_URL:?DATABASE_URL is required}
      REDIS_HOST: ${REDIS_HOST:-shared-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD:?REDIS_PASSWORD is required}
      REDIS_DB: ${REDIS_DB:-3}
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET is required}
      # Optional API Keys
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY:-}
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-}
      SENTRY_DSN: ${SENTRY_DSN:-}
      # Reverse Proxy
      VIRTUAL_HOST: ${VIRTUAL_HOST:-api.wpma.io}
      LETSENCRYPT_HOST: ${LETSENCRYPT_HOST:-api.wpma.io}
      VIRTUAL_PORT: ${VIRTUAL_PORT:-8000}
    networks:
      - proxy-network
      - shared-network
      - wpma-network
    restart: unless-stopped

  frontend:
    build:
      context: ./wpma-frontend
      dockerfile: Dockerfile
    container_name: wpma-frontend
    ports:
      - "127.0.0.1:3000:3000"
    environment:
      NEXT_PUBLIC_API_URL: "https://api.wpma.io"
      NODE_ENV: "production"
      VIRTUAL_HOST: "app.wpma.io"
      LETSENCRYPT_HOST: "app.wpma.io"
      VIRTUAL_PORT: "3000"
    networks:
      - proxy-network
      - wpma-network
    restart: unless-stopped
    depends_on:
      - backend

  landing:
    image: nginx:alpine
    container_name: wpma-landing
    ports:
      - "127.0.0.1:8081:80"
    volumes:
      - ./landing:/usr/share/nginx/html
      - ./landing/nginx.conf:/etc/nginx/nginx.conf:ro
    environment:
      VIRTUAL_HOST: "wpma.io,www.wpma.io"
      LETSENCRYPT_HOST: "wpma.io,www.wpma.io"
    networks:
      - proxy-network
    restart: unless-stopped

networks:
  proxy-network:
    external: true
  shared-network:
    external: true
  wpma-network:
    driver: bridge

# Production-spezifische Erweiterungen hinzugef√ºgt in der Basis-Config
